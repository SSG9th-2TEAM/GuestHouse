package com.ssg9th2team.geharbang.controller;

import com.ssg9th2team.geharbang.domain.auth.entity.User;
import com.ssg9th2team.geharbang.domain.auth.repository.UserRepository;
import com.ssg9th2team.geharbang.domain.chat.dto.ChatMessageDto;
import com.ssg9th2team.geharbang.domain.chat.dto.ChatMessageRequest;
import com.ssg9th2team.geharbang.domain.chat.service.RealtimeChatService;
import lombok.RequiredArgsConstructor;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.messaging.handler.annotation.DestinationVariable;
import org.springframework.messaging.handler.annotation.MessageMapping;
import org.springframework.messaging.handler.annotation.Payload;
import org.springframework.messaging.simp.SimpMessagingTemplate;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Controller;

@Controller
@RequiredArgsConstructor
public class RealtimeChatWebSocketController {

    private static final Logger log = LoggerFactory.getLogger(RealtimeChatWebSocketController.class);
    private final RealtimeChatService chatService;
    private final SimpMessagingTemplate messagingTemplate;
    private final UserRepository userRepository; // UserRepository 주입

    @MessageMapping("/chat/{roomId}/send")
    public void sendMessage(
            @DestinationVariable Long roomId,
            @Payload ChatMessageRequest request,
            @AuthenticationPrincipal UserDetails userDetails) {

        if (userDetails == null) {
            log.warn("Unauthenticated user attempted to send message to room {}", roomId);
            return;
        }

        try {
            User user = userRepository.findByEmail(userDetails.getUsername())
                    .orElseThrow(() -> new UsernameNotFoundException("User not found: " + userDetails.getUsername()));
            Long senderUserId = user.getId();

            ChatMessageDto message = chatService.saveMessage(roomId, senderUserId, request.getContent());
            messagingTemplate.convertAndSend("/topic/chatroom/" + roomId, message);
        } catch (Exception e) {
            log.error("Error sending message in room {}: {}", roomId, e.getMessage());
            // Optionally, send an error message back to the user
            // messagingTemplate.convertAndSendToUser(userDetails.getUsername(), "/queue/errors", e.getMessage());
        }
    }
}
