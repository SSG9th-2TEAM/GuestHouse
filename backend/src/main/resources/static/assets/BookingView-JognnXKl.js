import{_ as z,r as v,b as G,s as j,q as w,c as u,e,k as H,D as J,d as f,t as n,C as K,H as Q,F as W,f as Y,z as M,m as X,G as Z,I as ee,o as d}from"./index-Br9ce33d.js";import{createReservation as te}from"./reservationApi-yKiDszUT.js";import{f as oe}from"./accommodation-B0CbHFXA.js";import{g as se}from"./userClient-ZqBkEsnD.js";import{a as ae}from"./couponApi-FW6EOuf0.js";const ne={class:"booking-page"},re={class:"container content"},ie={class:"booking-card"},ce={key:0,class:"img-placeholder"},le={class:"card-body"},ue={class:"property-info"},de={class:"address"},me={key:0,class:"rating"},ve={class:"info-row room-info-box"},pe={class:"info-value room-name"},ge={key:0,class:"info-sub"},he={class:"info-sub"},ye={class:"info-row"},fe={class:"info-value"},_e={class:"info-row"},ke={class:"info-value"},Ie={class:"info-row"},De=["value"],Ne={class:"price-section"},we={class:"price-row"},Ce={key:0,class:"price-row"},be={class:"discount-text"},Se={class:"total-row"},qe={class:"total-price"},xe={class:"currency"},Pe={class:"policy-section"},Te={key:0},Ve={key:1},Le={class:"bottom-action"},Re={key:0,class:"error-message"},Me=["disabled"],Be={__name:"BookingView",props:{accommodationsId:[String,Number],roomId:[String,Number],guestCount:[String,Number],checkin:String,checkout:String},setup(B){const C=H(),i=j(),p=B,b=v(null),S=v(null),k=v(null),E=v(!0);G(async()=>{const a=parseInt(p.accommodationsId)||parseInt(i.params.id),t=parseInt(p.roomId)||parseInt(i.query.roomId);if(a)try{const s=await oe(a);s.ok&&s.data&&(b.value=s.data,t&&s.data.rooms&&(S.value=s.data.rooms.find(r=>r.roomId===t||r.id===t)))}catch(s){console.error("숙소 정보 로드 실패:",s)}try{const s=await se();s.ok&&s.data&&(k.value=s.data)}catch(s){console.error("사용자 정보 조회 실패:",s)}try{const s=await ae("ISSUED");q.value=s||[]}catch(s){console.error("쿠폰 조회 실패:",s)}E.value=!1});const F=(a,t)=>{if(!a||!t)return 1;const s=new Date(a),l=new Date(t).getTime()-s.getTime(),g=Math.ceil(l/(1e3*60*60*24));return g>0?g:1},I=a=>{if(!a)return"";const t=new Date(a);if(Number.isNaN(t.getTime()))return"";const s=t.getFullYear(),r=t.getMonth()+1,l=t.getDate();return`${s}년 ${r}월 ${l}일`},o=w(()=>{const a=parseInt(p.guestCount),t=parseInt(i.query.guestCount),s=Number.isNaN(a)?Number.isNaN(t)?1:t:a,r=`게스트 ${s}명`;let l=p.checkin||i.query.checkin||i.query.checkIn||null,g=p.checkout||i.query.checkout||i.query.checkOut||null,x="날짜를 선택하세요";if(l&&g){const L=I(l),R=I(g);L&&R&&(x=`${L} ~ ${R}`)}const P=F(l,g),c=b.value,m=S.value;let N="https://picsum.photos/id/11/800/400";c?.images&&c.images.length>0&&(N=c.images[0].imageUrl||N);let T="";c&&(T=[c.city,c.district,c.township,c.addressDetail].filter(Boolean).join(" "));const V=m?.price||m?.weekendPrice||parseInt(i.query.roomPrice)||15e4;return{accommodationsId:parseInt(p.accommodationsId)||parseInt(i.params.id)||2,roomId:parseInt(p.roomId)||parseInt(i.query.roomId)||2,accommodationName:c?.accommodationsName||i.query.accommodationName||"숙소명 없음",address:T||"주소 정보 없음",rating:c?.rating||parseFloat(i.query.rating)||0,reviewCount:c?.reviewCount||parseInt(i.query.reviewCount)||0,image:N,roomName:m?.roomName||m?.name||i.query.roomName||"객실명 없음",roomDesc:m?.roomDescription||m?.description||"",roomCapacity:m?.maxGuests||m?.capacity||s,dates:x,checkin:l,checkout:g,stayNights:P,guests:r,guestCount:s,price:V*P,pricePerNight:V,currency:"KRW"}}),q=v([]),h=v(null),_=v(!1),y=v(""),$=(a,t)=>{if(!a)return 0;if(a.discountType==="PERCENT"){const s=Math.floor(t*a.discountValue/100);return a.maxDiscount?Math.min(s,a.maxDiscount):s}return a.discountValue||0},D=w(()=>$(h.value,o.value.price)),U=w(()=>o.value.price-D.value),O=()=>C.back(),A=async()=>{_.value=!0,y.value="";try{const a=new Date,t=o.value.checkin?new Date(o.value.checkin):new Date(a.getTime()+1440*60*1e3),s=o.value.checkout?new Date(o.value.checkout):new Date(a.getTime()+2880*60*1e3);console.log("예약 생성 데이터:",{checkin:o.value.checkin,checkout:o.value.checkout,guestCount:o.value.guestCount,stayNights:o.value.stayNights,guests:o.value.guests});const r={accommodationsId:o.value.accommodationsId,roomId:o.value.roomId,checkin:t.toISOString(),checkout:s.toISOString(),guestCount:o.value.guestCount,totalAmount:o.value.price,userCouponId:h.value?.id||null,couponDiscountAmount:D.value||0,reserverName:k.value?.email||"예약자",reserverPhone:k.value?.phone||""};console.log("Final Reservation Data Payload:",JSON.stringify(r,null,2));const l=await te(r);C.push({name:"payment",params:{reservationId:l.reservationId}})}catch(a){console.error("예약 생성 실패:",a),a.message.includes("409")||a.message.includes("Conflict")?y.value="선택하신 날짜에 이미 예약이 존재합니다. 다른 날짜를 선택해주세요.":y.value="예약 처리 중 오류가 발생했습니다. 다시 시도해주세요."}finally{_.value=!1}};return(a,t)=>{const s=ee("router-link");return d(),u("div",ne,[e("header",{class:"header"},[e("button",{class:"icon-btn",onClick:O},"←")]),e("div",re,[t[10]||(t[10]=e("h1",{class:"page-title"},"검토 후 계속 진행",-1)),e("div",ie,[e("div",{class:"card-image",style:J({backgroundImage:`url(${o.value.image})`})},[o.value.image?f("",!0):(d(),u("span",ce,"[숙소 이미지]"))],4),e("div",le,[e("div",ue,[e("h2",null,n(o.value.accommodationName),1),e("p",de,n(o.value.address),1),o.value.rating?(d(),u("p",me,"★ "+n(o.value.rating)+" (후기 "+n(o.value.reviewCount)+"개)",1)):f("",!0)]),e("div",ve,[t[1]||(t[1]=e("div",{class:"info-label"},[e("span",null,"선택 객실")],-1)),e("p",pe,n(o.value.roomName),1),o.value.roomDesc?(d(),u("p",ge,n(o.value.roomDesc),1)):f("",!0),e("p",he,"최대 "+n(o.value.roomCapacity)+"명",1)]),e("div",ye,[t[2]||(t[2]=e("div",{class:"info-label"},[e("span",null,"날짜")],-1)),e("p",fe,n(o.value.dates)+" ("+n(o.value.stayNights)+"박)",1)]),e("div",_e,[t[3]||(t[3]=e("div",{class:"info-label"},[e("span",null,"게스트")],-1)),e("p",ke,n(o.value.guests),1)]),e("div",Ie,[t[5]||(t[5]=e("div",{class:"info-label"},[e("span",null,"쿠폰")],-1)),K(e("select",{"onUpdate:modelValue":t[0]||(t[0]=r=>h.value=r),class:"coupon-select"},[t[4]||(t[4]=e("option",{value:null},"쿠폰 선택 안함",-1)),(d(!0),u(W,null,Y(q.value,r=>(d(),u("option",{key:r.id,value:r},n(r.name)+" ("+n(r.discountType==="PERCENT"?r.discountValue+"%":r.discountValue.toLocaleString()+"원")+" 할인) ",9,De))),128))],512),[[Q,h.value]])]),t[8]||(t[8]=e("hr",{class:"divider"},null,-1)),e("div",Ne,[e("div",we,[e("span",null,"₩"+n(o.value.pricePerNight.toLocaleString())+" x "+n(o.value.stayNights)+"박",1),e("span",null,"₩"+n(o.value.price.toLocaleString()),1)]),h.value?(d(),u("div",Ce,[e("span",null,"쿠폰 할인 ("+n(h.value.name)+")",1),e("span",be,"-₩"+n(D.value.toLocaleString()),1)])):f("",!0),e("div",Se,[t[6]||(t[6]=e("span",null,"총 합계",-1)),e("div",qe,[M(" ₩"+n(U.value.toLocaleString())+" ",1),e("span",xe,n(o.value.currency),1)])])]),t[9]||(t[9]=e("hr",{class:"divider"},null,-1)),e("div",Pe,[o.value.checkin?(d(),u("p",Te," 체크인 날짜인 "+n(I(o.value.checkin))+" 전에 취소하면 부분 환불을 받으실 수 있습니다. ",1)):(d(),u("p",Ve,"취소 시 환불 정책이 적용됩니다.")),X(s,{to:"/policy?tab=refund",class:"policy-link"},{default:Z(()=>[...t[7]||(t[7]=[M("환불 정책 전문",-1)])]),_:1})])])])]),e("div",Le,[y.value?(d(),u("div",Re,n(y.value),1)):f("",!0),e("button",{class:"pay-btn",disabled:_.value,onClick:A},n(_.value?"처리 중...":"결제하기"),9,Me)])])}}},Ae=z(Be,[["__scopeId","data-v-2b15a3cf"]]);export{Ae as default};
