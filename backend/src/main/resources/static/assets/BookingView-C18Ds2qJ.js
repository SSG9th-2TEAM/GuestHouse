import{_ as G,r as m,b as j,s as J,q as C,c as u,e as t,d as y,k as K,D as Q,t as r,C as W,H as Y,F as $,f as X,z as E,m as Z,G as ee,I as te,n as oe,o as d}from"./index-CdO51RKj.js";import{createReservation as se}from"./reservationApi-CJCzkSxj.js";import{f as ae}from"./accommodation-D4icBdyG.js";import{g as ne}from"./userClient-93NOCQB2.js";import{a as re}from"./couponApi-BQJ9jWDs.js";const ie={class:"booking-page"},le={class:"container content"},ce={class:"booking-card"},ue={key:0,class:"img-placeholder"},de={class:"card-body"},me={class:"property-info"},ve={class:"address"},pe={key:0,class:"rating"},ge={class:"info-row room-info-box"},he={class:"info-value room-name"},fe={key:0,class:"info-sub"},ye={class:"info-sub"},ke={class:"info-row"},_e={class:"info-value"},Ie={class:"info-row"},De={class:"info-value"},Ne={class:"info-row"},be=["value"],Ce={class:"price-section"},we={class:"price-row"},Se={key:0,class:"price-row"},Te={class:"discount-text"},qe={class:"total-row"},xe={class:"total-price"},Me={class:"currency"},Pe={class:"policy-section"},Le={key:0},Ve={key:1},Re={class:"bottom-action"},$e=["disabled"],Ee={class:"modal-content error-modal"},Be=["innerHTML"],Fe={__name:"BookingView",props:{accommodationsId:[String,Number],roomId:[String,Number],guestCount:[String,Number],checkin:String,checkout:String},setup(B){const w=K(),i=J(),p=B,S=m(null),T=m(null),I=m(null),F=m(!0);j(async()=>{const a=parseInt(p.accommodationsId)||parseInt(i.params.id),e=parseInt(p.roomId)||parseInt(i.query.roomId);if(a)try{const s=await ae(a);s.ok&&s.data&&(S.value=s.data,e&&s.data.rooms&&(T.value=s.data.rooms.find(n=>n.roomId===e||n.id===e)))}catch(s){console.error("숙소 정보 로드 실패:",s)}try{const s=await ne();s.ok&&s.data&&(I.value=s.data)}catch(s){console.error("사용자 정보 조회 실패:",s)}try{const s=await re("ISSUED");q.value=s||[]}catch(s){console.error("쿠폰 조회 실패:",s)}F.value=!1});const O=(a,e)=>{if(!a||!e)return 1;const s=new Date(a),c=new Date(e).getTime()-s.getTime(),g=Math.ceil(c/(1e3*60*60*24));return g>0?g:1},D=a=>{if(!a)return"";const e=new Date(a);if(Number.isNaN(e.getTime()))return"";const s=e.getFullYear(),n=e.getMonth()+1,c=e.getDate();return`${s}년 ${n}월 ${c}일`},o=C(()=>{const a=parseInt(p.guestCount),e=parseInt(i.query.guestCount),s=Number.isNaN(a)?Number.isNaN(e)?1:e:a,n=`게스트 ${s}명`;let c=p.checkin||i.query.checkin||i.query.checkIn||null,g=p.checkout||i.query.checkout||i.query.checkOut||null,x="날짜를 선택하세요";if(c&&g){const V=D(c),R=D(g);V&&R&&(x=`${V} ~ ${R}`)}const M=O(c,g),l=S.value,v=T.value;let b="https://picsum.photos/id/11/800/400";l?.images&&l.images.length>0&&(b=l.images[0].imageUrl||b);let P="";l&&(P=[l.city,l.district,l.township,l.addressDetail].filter(Boolean).join(" "));const L=v?.price||v?.weekendPrice||parseInt(i.query.roomPrice)||15e4;return{accommodationsId:parseInt(p.accommodationsId)||parseInt(i.params.id)||2,roomId:parseInt(p.roomId)||parseInt(i.query.roomId)||2,accommodationName:l?.accommodationsName||i.query.accommodationName||"숙소명 없음",address:P||"주소 정보 없음",rating:l?.rating||parseFloat(i.query.rating)||0,reviewCount:l?.reviewCount||parseInt(i.query.reviewCount)||0,image:b,roomName:v?.roomName||v?.name||i.query.roomName||"객실명 없음",roomDesc:v?.roomDescription||v?.description||"",roomCapacity:v?.maxGuests||v?.capacity||s,dates:x,checkin:c,checkout:g,stayNights:M,guests:n,guestCount:s,price:L*M,pricePerNight:L,currency:"KRW"}}),q=m([]),h=m(null),k=m(!1),_=m(""),f=m(!1),U=(a,e)=>{if(!a)return 0;if(a.discountType==="PERCENT"){const s=Math.floor(e*a.discountValue/100);return a.maxDiscount?Math.min(s,a.maxDiscount):s}return a.discountValue||0},N=C(()=>U(h.value,o.value.price)),A=C(()=>o.value.price-N.value),H=()=>w.back(),z=async()=>{k.value=!0,_.value="";try{const a=new Date,e=o.value.checkin?new Date(o.value.checkin):new Date(a.getTime()+1440*60*1e3),s=o.value.checkout?new Date(o.value.checkout):new Date(a.getTime()+2880*60*1e3);console.log("예약 생성 데이터:",{checkin:o.value.checkin,checkout:o.value.checkout,guestCount:o.value.guestCount,stayNights:o.value.stayNights,guests:o.value.guests});const n={accommodationsId:o.value.accommodationsId,roomId:o.value.roomId,checkin:e.toISOString(),checkout:s.toISOString(),guestCount:o.value.guestCount,totalAmount:o.value.price,userCouponId:h.value?.id||null,couponDiscountAmount:N.value||0,reserverName:I.value?.email||"예약자",reserverPhone:I.value?.phone||""};console.log("Final Reservation Data Payload:",JSON.stringify(n,null,2));const c=await se(n);w.push({name:"payment",params:{reservationId:c.reservationId}})}catch(a){console.error("예약 생성 실패:",a),a.message.includes("409")||a.message.includes("Conflict")?(_.value="선택하신 날짜에 이미 예약이 존재합니다.<br>다른 날짜를 선택해주세요.",f.value=!0):(_.value="예약 처리 중 오류가 발생했습니다.<br>다시 시도해주세요.",f.value=!0)}finally{k.value=!1}};return(a,e)=>{const s=te("router-link");return d(),u($,null,[t("div",ie,[t("header",{class:"header"},[t("button",{class:"icon-btn",onClick:H},"←")]),t("div",le,[e[12]||(e[12]=t("h1",{class:"page-title"},"검토 후 계속 진행",-1)),t("div",ce,[t("div",{class:"card-image",style:Q({backgroundImage:`url(${o.value.image})`})},[o.value.image?y("",!0):(d(),u("span",ue,"[숙소 이미지]"))],4),t("div",de,[t("div",me,[t("h2",null,r(o.value.accommodationName),1),t("p",ve,r(o.value.address),1),o.value.rating?(d(),u("p",pe,"★ "+r(o.value.rating)+" (후기 "+r(o.value.reviewCount)+"개)",1)):y("",!0)]),t("div",ge,[e[3]||(e[3]=t("div",{class:"info-label"},[t("span",null,"선택 객실")],-1)),t("p",he,r(o.value.roomName),1),o.value.roomDesc?(d(),u("p",fe,r(o.value.roomDesc),1)):y("",!0),t("p",ye,"최대 "+r(o.value.roomCapacity)+"명",1)]),t("div",ke,[e[4]||(e[4]=t("div",{class:"info-label"},[t("span",null,"날짜")],-1)),t("p",_e,r(o.value.dates)+" ("+r(o.value.stayNights)+"박)",1)]),t("div",Ie,[e[5]||(e[5]=t("div",{class:"info-label"},[t("span",null,"게스트")],-1)),t("p",De,r(o.value.guests),1)]),t("div",Ne,[e[7]||(e[7]=t("div",{class:"info-label"},[t("span",null,"쿠폰")],-1)),W(t("select",{"onUpdate:modelValue":e[0]||(e[0]=n=>h.value=n),class:"coupon-select"},[e[6]||(e[6]=t("option",{value:null},"쿠폰 선택 안함",-1)),(d(!0),u($,null,X(q.value,n=>(d(),u("option",{key:n.id,value:n},r(n.name)+" ("+r(n.discountType==="PERCENT"?n.discountValue+"%":n.discountValue.toLocaleString()+"원")+" 할인) ",9,be))),128))],512),[[Y,h.value]])]),e[10]||(e[10]=t("hr",{class:"divider"},null,-1)),t("div",Ce,[t("div",we,[t("span",null,"₩"+r(o.value.pricePerNight.toLocaleString())+" x "+r(o.value.stayNights)+"박",1),t("span",null,"₩"+r(o.value.price.toLocaleString()),1)]),h.value?(d(),u("div",Se,[t("span",null,"쿠폰 할인 ("+r(h.value.name)+")",1),t("span",Te,"-₩"+r(N.value.toLocaleString()),1)])):y("",!0),t("div",qe,[e[8]||(e[8]=t("span",null,"총 합계",-1)),t("div",xe,[E(" ₩"+r(A.value.toLocaleString())+" ",1),t("span",Me,r(o.value.currency),1)])])]),e[11]||(e[11]=t("hr",{class:"divider"},null,-1)),t("div",Pe,[o.value.checkin?(d(),u("p",Le," 체크인 날짜인 "+r(D(o.value.checkin))+" 전에 취소하면 부분 환불을 받으실 수 있습니다. ",1)):(d(),u("p",Ve,"취소 시 환불 정책이 적용됩니다.")),Z(s,{to:"/policy?tab=refund",class:"policy-link"},{default:ee(()=>[...e[9]||(e[9]=[E("환불 정책 전문",-1)])]),_:1})])])])]),t("div",Re,[t("button",{class:"pay-btn",disabled:k.value,onClick:z},r(k.value?"처리 중...":"결제하기"),9,$e)])]),f.value?(d(),u("div",{key:0,class:"modal-overlay",onClick:e[2]||(e[2]=oe(n=>f.value=!1,["self"]))},[t("div",Ee,[e[13]||(e[13]=t("div",{class:"modal-icon error"},"⚠️",-1)),e[14]||(e[14]=t("h3",null,"예약 실패",-1)),t("p",{class:"modal-desc",innerHTML:_.value},null,8,Be),t("button",{class:"close-modal-btn",onClick:e[1]||(e[1]=n=>f.value=!1)},"확인")])])):y("",!0)],64)}}},Ge=G(Fe,[["__scopeId","data-v-d209965a"]]);export{Ge as default};
