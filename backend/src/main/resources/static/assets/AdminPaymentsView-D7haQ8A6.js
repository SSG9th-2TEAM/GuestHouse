import{_ as Et,r as l,b as xt,s as Nt,q as $,y as st,c as i,e as t,m as lt,d as x,F as V,f as U,C as N,E as ot,I as X,t as s,z as ut,H as Pt,p as T,k as Rt,o,l as Ft,D as $t}from"./index-CMhx5Eqk.js";import{A as Vt}from"./AdminStatCard-CeRT2I1g.js";import{A as Ut}from"./AdminBadge-BD_Hrkfc.js";import{A as Tt}from"./AdminTableCard-DCRw99gY.js";import{e as qt,a as Mt}from"./reportExport-DvZZ7m0X.js";import{m as zt,n as Yt,o as Bt,p as it,q as Ot}from"./adminApi-ikFfbPlF.js";import{e as Qt,a as Xt,t as dt}from"./adminData-ZmZ3C3cR.js";import{b as Gt,r as Ht}from"./adminReservationPolicy-DT_2QSAw.js";const Kt={0:"요청",1:"완료",2:"실패",3:"환불"},jt={0:"neutral",1:"success",2:"danger",3:"warning"},G=D=>{const b=Number(D);return Number.isFinite(b)?Kt[b]??`알 수 없음(${D})`:"알 수 없음"},Jt=D=>{const b=Number(D);return jt[b]??"neutral"},Wt={class:"admin-page"},Zt={class:"admin-grid"},te={class:"admin-filter-bar"},ee={class:"admin-filter-group"},ae={class:"admin-filter-group"},ne={class:"admin-filter-group"},se={class:"admin-dropdown"},le={class:"admin-dropdown__menu"},oe={class:"admin-card admin-transaction-card"},ue={class:"admin-card__head"},ie={class:"admin-card__title"},de={class:"admin-toggle-group"},re=["value"],me={class:"admin-toggle"},ve={key:0,class:"admin-chart-status"},ce={key:1,class:"admin-chart-status"},pe={key:2,class:"admin-chart-status"},ye={key:3,class:"admin-transaction-bars"},be={class:"admin-transaction-bar__value"},fe={class:"admin-transaction-bar__amount"},ge={class:"admin-table--nowrap admin-table--tight admin-table--stretch"},_e={class:"admin-strong"},ke=["title"],Se={class:"admin-align-right"},Ae={class:"admin-inline-actions admin-inline-actions--nowrap admin-actions-right"},Le=["onClick"],we=["disabled","title","onClick"],he={key:0,class:"admin-status"},Ie={key:1,class:"admin-status"},Ce={key:2,class:"admin-status"},De={class:"admin-pagination"},Ee=["disabled"],xe=["disabled"],Ne={key:0,class:"admin-modal"},Pe={class:"admin-modal__card"},Re={class:"admin-modal__header"},Fe={class:"admin-modal__title"},$e={key:0,class:"admin-status"},Ve={key:1,class:"admin-status"},Ue={key:2,class:"admin-detail-grid"},Te={key:1,class:"admin-modal"},qe={class:"admin-modal__card admin-modal__card--small"},Me={class:"admin-detail-grid admin-detail-grid--compact"},ze={class:"admin-form"},Ye=["disabled"],Be={key:0,class:"admin-status"},Oe={class:"admin-modal__actions"},Qe=["disabled"],Xe=["disabled"],Ge={__name:"AdminPaymentsView",setup(D){const b=l([]),H=l([]),c=l(""),d=l("ALL"),r=l("ALL"),f=l(new Date().getFullYear()),p=l("yearly"),y=l([]),q=l(!1),A=l(""),m=l(0),K=l(20),M=l(0),rt=l(0),z=l(!1),P=l(""),j=l(!1),J=l(""),L=l(null),Y=l(!1),w=l(!1),g=l(""),u=l(null),B=l(!1),_=l(!1),h=l(""),k=l(null),E=l(""),I=Nt(),mt=Rt(),vt=n=>{if(!n)return"ALL";const e=String(n).trim().toUpperCase();return["ALL","SUCCESS","FAILED","REFUNDED"].includes(e)?e:"ALL"},ct=n=>{if(!n)return"ALL";const e=String(n).trim().toUpperCase();return["ALL","RESERVATION","REFUND"].includes(e)?e:"ALL"},S=async()=>{z.value=!0,P.value="";const n=await zt({status:d.value,type:r.value,keyword:c.value||void 0,page:m.value,size:K.value,sort:"latest"});if(n.ok&&n.data){const e=n.data;H.value=Qt(e);const a=Xt(e);m.value=a.page,K.value=a.size,M.value=a.totalPages,rt.value=a.totalElements,W()}else P.value="결제 목록을 불러오지 못했습니다.";z.value=!1},pt=()=>{const n=new Date;if(p.value==="monthly"){const v=f.value||n.getFullYear();return{from:`${v}-01-01`,to:`${v}-12-31`}}const e=n.getFullYear();return{from:`${e-4}-01-01`,to:`${e}-12-31`}},R=async()=>{j.value=!0,J.value="";const n=pt(),e=await Bt({status:d.value==="ALL"?void 0:d.value,type:r.value==="ALL"?void 0:r.value,keyword:c.value||void 0,...n});e.ok&&e.data?(L.value=e.data,W()):(J.value="요약 지표를 불러오지 못했습니다.",L.value=null),j.value=!1},W=()=>{L.value&&(b.value=[{label:"총 거래액",value:`${Number(L.value.grossAmount??0).toLocaleString()}원`,sub:"기간 기준",tone:"primary"},{label:"순매출",value:`${Number(L.value.netAmount??0).toLocaleString()}원`,sub:"환불 반영",tone:"success"},{label:"환불 완료",value:`${Number(L.value.refundCompletedCount??0).toLocaleString()}건`,sub:"기간 기준",tone:"accent"}])},C=async()=>{const n={url:"/api/admin/payments/metrics",params:{mode:p.value,year:f.value,status:d.value,type:r.value,keyword:c.value||void 0}};q.value=!0,A.value="";const e={mode:p.value,year:f.value,status:d.value==="ALL"?void 0:d.value,type:r.value==="ALL"?void 0:r.value,keyword:c.value||void 0};try{const a=await Yt(e);if(a.ok&&Array.isArray(a.data))y.value=a.data;else if(a.ok){const v=new Error("Invalid metrics response shape");console.error("[AdminPaymentsView] metrics response shape error",{request:n,status:a?.status,responseBody:a?.data,error:v}),A.value="차트를 불러오지 못했습니다.",y.value=[]}else console.error("[AdminPaymentsView] metrics request failed",{request:n,status:a?.status,responseBody:a?.data}),A.value="차트를 불러오지 못했습니다.",y.value=[]}catch(a){console.error("[AdminPaymentsView] metrics exception",{request:n,error:a}),A.value="차트를 불러오지 못했습니다.",y.value=[]}q.value=!1},yt=n=>{const e={...I.query,...n},a=dt(e),v=dt(I.query);Object.keys({...a,...v}).every(nt=>String(a[nt]??"")===String(v[nt]??""))||mt.replace({query:a})};xt(()=>{d.value=vt(I.query.status),r.value=ct(I.query.type),c.value=I.query.keyword??"",m.value=Number(I.query.page??0),S(),C(),R()});const bt=n=>n==="SUCCESS"?"1":n==="FAILED"?"2":n==="REFUNDED"?"3":n,Z=n=>{p.value=n,y.value=[],C(),R()},ft=$(()=>{const n=y.value.map(e=>Number(e?.totalAmount??0));return n.length?Math.max(...n,1):1}),gt=n=>`${n/ft.value*100}%`,_t=$(()=>p.value==="monthly"?`${f.value}년 월별 거래액`:"연도별 거래액"),kt=$(()=>y.value.some(n=>Number(n?.totalAmount??0)>0)),O=$(()=>{const n=c.value.trim().toLowerCase();return H.value.filter(e=>{const a=!n||String(e.paymentId??"").includes(n)||(e.orderId??"").toLowerCase().includes(n)||(e.pgPaymentKey??"").toLowerCase().includes(n),v=d.value==="ALL"||String(e.paymentStatus)===bt(d.value),at=r.value==="ALL"||(r.value==="REFUND"?e.paymentStatus===3:e.paymentStatus!==3);return a&&v&&at})}),St=n=>{const e=Number(n);return Number.isFinite(e)?e===0?"요청":e===1?"완료":e===2?"실패":`알 수 없음(${n})`:"-"},Q=n=>n?String(n).replace("T"," ").slice(0,16):"-",F=n=>n==null?"-":`₩${Number(n).toLocaleString()}`,At=n=>{n?.paymentId&&(k.value=n,h.value="",E.value="",B.value=!0)},tt=()=>{B.value=!1,_.value=!1,h.value="",k.value=null,E.value=""},Lt=async()=>{if(!k.value?.paymentId)return;_.value=!0,h.value="";const n=E.value.trim(),e=n?{reason:n}:{},a=await Ot(k.value.paymentId,e);if(a.ok){tt(),S(),C();return}h.value=a?.data?.message||"환불 처리에 실패했습니다.",_.value=!1},wt=n=>Gt(n??{}),ht=n=>n?Ht(n??{}):"",It=async n=>{if(!n?.paymentId)return;Y.value=!0,w.value=!0,g.value="";const e=await it(n.paymentId);e.ok&&e.data?u.value=e.data:g.value="결제 상세 정보를 불러오지 못했습니다.",w.value=!1},Ct=()=>{Y.value=!1,w.value=!1,g.value="",u.value=null},Dt=async()=>{if(!u.value?.paymentId)return;w.value=!0,g.value="";const n=await it(u.value.paymentId);n.ok&&n.data?u.value=n.data:g.value="결제 상세 정보를 불러오지 못했습니다.",w.value=!1};st([c,d],()=>{m.value=0,yt({status:d.value==="ALL"?void 0:d.value,type:r.value==="ALL"?void 0:r.value,keyword:c.value||void 0,page:m.value}),S(),C(),R()}),st([r,f],()=>{S(),C(),R()});const et=n=>{const e=new Date().toISOString().slice(0,10),a=[{name:"결제 내역",columns:[{key:"id",label:"거래ID"},{key:"host",label:"호스트"},{key:"guest",label:"게스트"},{key:"accommodation",label:"숙소"},{key:"amount",label:"거래액"},{key:"fee",label:"수수료"},{key:"type",label:"유형"},{key:"status",label:"상태"},{key:"method",label:"결제수단"},{key:"settlementDate",label:"정산일"},{key:"date",label:"날짜"}],rows:O.value}];if(n==="xlsx"){qt({filename:`admin-payments-${e}.xlsx`,sheets:a});return}Mt({filename:`admin-payments-${e}.csv`,sheets:a})};return(n,e)=>(o(),i("section",Wt,[e[42]||(e[42]=t("header",{class:"admin-page__header"},[t("div",null,[t("h1",{class:"admin-title"},"결제 관리"),t("p",{class:"admin-subtitle"},"거래 흐름과 수수료를 모니터링합니다.")])],-1)),t("div",Zt,[(o(!0),i(V,null,U(b.value,a=>(o(),Ft(Vt,{key:a.label,label:a.label,value:a.value,sub:a.sub,tone:a.tone},null,8,["label","value","sub","tone"]))),128))]),t("div",te,[t("div",ee,[e[11]||(e[11]=t("span",{class:"admin-chip"},"검색",-1)),N(t("input",{"onUpdate:modelValue":e[0]||(e[0]=a=>c.value=a),class:"admin-input",type:"search",placeholder:"거래ID, 주문번호, 결제키"},null,512),[[ot,c.value]])]),t("div",ae,[e[14]||(e[14]=t("span",{class:"admin-chip"},"필터",-1)),N(t("select",{"onUpdate:modelValue":e[1]||(e[1]=a=>r.value=a),class:"admin-select"},[...e[12]||(e[12]=[t("option",{value:"ALL"},"전체 유형",-1),t("option",{value:"RESERVATION"},"예약",-1),t("option",{value:"REFUND"},"환불",-1)])],512),[[X,r.value]]),N(t("select",{"onUpdate:modelValue":e[2]||(e[2]=a=>d.value=a),class:"admin-select"},[...e[13]||(e[13]=[t("option",{value:"ALL"},"전체 상태",-1),t("option",{value:"SUCCESS"},"완료",-1),t("option",{value:"FAILED"},"실패",-1),t("option",{value:"REFUNDED"},"환불",-1)])],512),[[X,d.value]])]),e[16]||(e[16]=t("div",{class:"admin-filter-group"},[t("span",{class:"admin-chip"},"정산"),t("button",{class:"admin-btn admin-btn--ghost",type:"button"},"정산 예정"),t("button",{class:"admin-btn admin-btn--primary",type:"button"},"정산 실행")],-1)),t("div",ne,[t("details",se,[e[15]||(e[15]=t("summary",{class:"admin-btn admin-btn--ghost"},"다운로드",-1)),t("div",le,[t("button",{class:"admin-btn admin-btn--ghost admin-dropdown__item",type:"button",onClick:e[3]||(e[3]=a=>et("csv"))},"CSV"),t("button",{class:"admin-btn admin-btn--primary admin-dropdown__item",type:"button",onClick:e[4]||(e[4]=a=>et("xlsx"))},"XLSX")])])])]),t("div",oe,[t("div",ue,[t("div",null,[e[17]||(e[17]=t("p",{class:"admin-card__eyebrow"},"거래 모니터링",-1)),t("h3",ie,s(_t.value),1)]),t("div",de,[p.value==="monthly"?N((o(),i("select",{key:0,"onUpdate:modelValue":e[5]||(e[5]=a=>f.value=a),class:"admin-select admin-select--compact"},[(o(),i(V,null,U(5,a=>t("option",{key:a,value:new Date().getFullYear()-(a-1)},s(new Date().getFullYear()-(a-1))+"년 ",9,re)),64))],512)),[[X,f.value]]):x("",!0),t("div",me,[t("button",{type:"button",class:ut(["admin-toggle__btn",{"is-active":p.value==="yearly"}]),onClick:e[6]||(e[6]=a=>Z("yearly"))}," 연간 ",2),t("button",{type:"button",class:ut(["admin-toggle__btn",{"is-active":p.value==="monthly"}]),onClick:e[7]||(e[7]=a=>Z("monthly"))}," 월간 ",2)])])]),q.value?(o(),i("div",ve,"불러오는 중...")):A.value?(o(),i("div",ce,[t("span",null,s(A.value),1),t("button",{class:"admin-btn admin-btn--ghost",type:"button",onClick:C},"다시 시도")])):kt.value?(o(),i("div",ye,[(o(!0),i(V,null,U(y.value,a=>(o(),i("div",{key:a.label,class:"admin-transaction-bar"},[t("div",{class:"admin-transaction-bar__fill",style:$t({height:gt(a.totalAmount)})},null,4),t("span",be,s(a.label),1),t("span",fe,s(a.totalAmount.toLocaleString())+"원",1)]))),128))])):(o(),i("div",pe,"선택 조건의 거래 데이터가 없습니다."))]),lt(Tt,{title:"결제 내역"},{default:Pt(()=>[t("table",ge,[e[18]||(e[18]=t("colgroup",null,[t("col",{style:{width:"140px"}}),t("col",{style:{width:"220px"}}),t("col",{style:{width:"120px"}}),t("col",{style:{width:"140px"}}),t("col",{style:{width:"120px"}}),t("col",{style:{width:"140px"}}),t("col",{style:{width:"200px"}})],-1)),e[19]||(e[19]=t("thead",null,[t("tr",null,[t("th",null,"거래ID"),t("th",null,"주문번호"),t("th",null,"예약ID"),t("th",null,"거래액"),t("th",null,"상태"),t("th",null,"날짜"),t("th",{class:"admin-align-right"},"관리")])],-1)),t("tbody",null,[(o(!0),i(V,null,U(O.value,a=>(o(),i("tr",{key:a.paymentId},[t("td",_e,"#"+s(a.paymentId),1),t("td",{class:"admin-ellipsis",title:a.orderId},s(a.orderId??"-"),9,ke),t("td",null,"#"+s(a.reservationId??"-"),1),t("td",Se,"₩"+s(a.approvedAmount?.toLocaleString?.()??"0"),1),t("td",null,[lt(Ut,{text:T(G)(a.paymentStatus),variant:T(Jt)(a.paymentStatus)},null,8,["text","variant"])]),t("td",null,s(a.createdAt?.slice?.(0,10)??"-"),1),t("td",null,[t("div",Ae,[t("button",{class:"admin-btn admin-btn--ghost",type:"button",onClick:v=>It(a)},"상세",8,Le),t("button",{class:"admin-btn admin-btn--danger",type:"button",disabled:!wt(a),title:ht(a),onClick:v=>At(a)}," 환불 처리 ",8,we)])])]))),128))])]),z.value?(o(),i("div",he,"불러오는 중...")):P.value?(o(),i("div",Ie,[t("span",null,s(P.value),1),t("button",{class:"admin-btn admin-btn--ghost",type:"button",onClick:S},"다시 시도")])):O.value.length?x("",!0):(o(),i("div",Ce,"데이터가 없습니다.")),t("div",De,[t("button",{class:"admin-btn admin-btn--ghost",type:"button",disabled:m.value<=0,onClick:e[8]||(e[8]=a=>{m.value=m.value-1,S()})}," 이전 ",8,Ee),t("span",null,s(m.value+1)+" / "+s(Math.max(M.value,1)),1),t("button",{class:"admin-btn admin-btn--ghost",type:"button",disabled:m.value+1>=M.value,onClick:e[9]||(e[9]=a=>{m.value=m.value+1,S()})}," 다음 ",8,xe)])]),_:1}),Y.value?(o(),i("div",Ne,[t("div",Pe,[t("div",Re,[t("div",null,[e[20]||(e[20]=t("p",{class:"admin-modal__eyebrow"},"결제 상세",-1)),t("h2",Fe,"#"+s(u.value?.paymentId??"-"),1)]),t("button",{class:"admin-btn admin-btn--ghost",type:"button",onClick:Ct},"닫기")]),w.value?(o(),i("div",$e,"불러오는 중...")):g.value?(o(),i("div",Ve,[t("span",null,s(g.value),1),t("button",{class:"admin-btn admin-btn--ghost",type:"button",onClick:Dt},"다시 시도")])):(o(),i("div",Ue,[t("div",null,[e[21]||(e[21]=t("span",null,"예약 ID",-1)),t("strong",null,"#"+s(u.value?.reservationId??"-"),1)]),t("div",null,[e[22]||(e[22]=t("span",null,"숙소 ID",-1)),t("strong",null,"#"+s(u.value?.accommodationsId??"-"),1)]),t("div",null,[e[23]||(e[23]=t("span",null,"게스트 ID",-1)),t("strong",null,"#"+s(u.value?.userId??"-"),1)]),t("div",null,[e[24]||(e[24]=t("span",null,"예약 상태",-1)),t("strong",null,s(u.value?.reservationStatus??"-"),1)]),t("div",null,[e[25]||(e[25]=t("span",null,"주문번호",-1)),t("strong",null,s(u.value?.orderId??"-"),1)]),t("div",null,[e[26]||(e[26]=t("span",null,"PG 키",-1)),t("strong",null,s(u.value?.pgPaymentKey??"-"),1)]),t("div",null,[e[27]||(e[27]=t("span",null,"요청 금액",-1)),t("strong",null,s(F(u.value?.requestAmount)),1)]),t("div",null,[e[28]||(e[28]=t("span",null,"승인 금액",-1)),t("strong",null,s(F(u.value?.approvedAmount)),1)]),t("div",null,[e[29]||(e[29]=t("span",null,"결제 상태",-1)),t("strong",null,s(T(G)(u.value?.paymentStatus)),1)]),t("div",null,[e[30]||(e[30]=t("span",null,"결제 승인일",-1)),t("strong",null,s(Q(u.value?.approvedAt)),1)]),t("div",null,[e[31]||(e[31]=t("span",null,"환불 상태",-1)),t("strong",null,s(St(u.value?.refundStatus)),1)]),t("div",null,[e[32]||(e[32]=t("span",null,"환불 금액",-1)),t("strong",null,s(F(u.value?.refundAmount)),1)]),t("div",null,[e[33]||(e[33]=t("span",null,"환불일시",-1)),t("strong",null,s(Q(u.value?.refundApprovedAt)),1)]),t("div",null,[e[34]||(e[34]=t("span",null,"환불 사유",-1)),t("strong",null,s(u.value?.refundReason??"-"),1)]),t("div",null,[e[35]||(e[35]=t("span",null,"생성일",-1)),t("strong",null,s(Q(u.value?.createdAt)),1)])]))])])):x("",!0),B.value?(o(),i("div",Te,[t("div",qe,[e[40]||(e[40]=t("div",{class:"admin-modal__header"},[t("div",null,[t("p",{class:"admin-modal__eyebrow"},"환불 처리"),t("h2",{class:"admin-modal__title"},"정말 환불 처리하시겠습니까?")])],-1)),t("div",Me,[t("div",null,[e[36]||(e[36]=t("span",null,"거래ID",-1)),t("strong",null,"#"+s(k.value?.paymentId??"-"),1)]),t("div",null,[e[37]||(e[37]=t("span",null,"거래액",-1)),t("strong",null,s(F(k.value?.approvedAmount)),1)]),t("div",null,[e[38]||(e[38]=t("span",null,"상태",-1)),t("strong",null,s(T(G)(k.value?.paymentStatus)),1)])]),t("div",ze,[e[39]||(e[39]=t("label",{class:"admin-form__label",for:"refund-reason"},"환불 사유 (선택)",-1)),N(t("textarea",{id:"refund-reason","onUpdate:modelValue":e[10]||(e[10]=a=>E.value=a),class:"admin-input",rows:"3",placeholder:"예) 고객 요청으로 환불 처리",disabled:_.value},null,8,Ye),[[ot,E.value]])]),e[41]||(e[41]=t("p",{class:"admin-modal__note"},"V1에서는 실제 PG 환불이 아닌 상태 변경 처리입니다.",-1)),h.value?(o(),i("div",Be,s(h.value),1)):x("",!0),t("div",Oe,[t("button",{class:"admin-btn admin-btn--ghost",type:"button",disabled:_.value,onClick:tt},"취소",8,Qe),t("button",{class:"admin-btn admin-btn--danger",type:"button",disabled:_.value,onClick:Lt},s(_.value?"처리 중...":"환불 처리"),9,Xe)])])])):x("",!0)]))}},aa=Et(Ge,[["__scopeId","data-v-78746df4"]]);export{aa as default};
