import{_ as j,r as g,d as z,y as K,m as Q,x as I,B as W,c as d,e as t,f as y,G as Y,t as r,w as X,J as Z,F as B,i as ee,D as E,p as te,I as oe,L as se,q as ae,o as m}from"./index-ChMRK3m0.js";import{createReservation as ne}from"./reservationApi-fGjZwGlE.js";import{f as re}from"./accommodation-JOKDnMel.js";import{g as ie}from"./userClient-GbEkmxfm.js";import{b as ce}from"./couponApi-GsG77FYn.js";const le={class:"booking-page"},ue={class:"container content"},de={class:"booking-card"},me={key:0,class:"img-placeholder"},ve={class:"card-body"},pe={class:"property-info"},ge={class:"address"},he={key:0,class:"rating"},fe={class:"info-row room-info-box"},ye={class:"info-value room-name"},ke={key:0,class:"info-sub"},_e={class:"info-sub"},De={class:"info-row"},Ie={class:"info-value"},we={class:"info-row"},Ne={class:"info-value"},be={class:"info-row"},Ce=["value"],Se={class:"price-section"},Te={class:"price-row"},qe={key:0,class:"price-row"},Pe={class:"discount-text"},xe={class:"total-row"},Le={class:"total-price"},Me={class:"currency"},Ve={class:"policy-section"},Re={key:0},$e={key:1},Be={class:"bottom-action"},Ee=["disabled"],Fe={class:"modal-content error-modal"},He=["innerHTML"],Oe={__name:"BookingView",props:{accommodationsId:[String,Number],roomId:[String,Number],guestCount:[String,Number],checkin:String,checkout:String},setup(F){const k=Q(),c=K(),v=F,S=g(null),T=g(null),w=g(null),H=g(!0);z(async()=>{const a=parseInt(v.accommodationsId)||parseInt(c.params.id),e=parseInt(v.roomId)||parseInt(c.query.roomId),i=v.checkin||c.query.checkin||c.query.checkIn,n=v.checkout||c.query.checkout||c.query.checkOut;if(i){const s=new Date;s.setHours(0,0,0,0);const l=new Date(i);if(l.setHours(0,0,0,0),l.getTime()<s.getTime()){alert(`과거 날짜로는 예약할 수 없습니다.
날짜를 다시 선택해주세요.`),k.back();return}}if(n){const s=new Date;s.setHours(0,0,0,0);const l=new Date(n);if(l.setHours(0,0,0,0),l.getTime()<=s.getTime()){alert(`체크아웃 날짜는 오늘 이후여야 합니다.
날짜를 다시 선택해주세요.`),k.back();return}}if(a)try{const s=await re(a);s.ok&&s.data&&(S.value=s.data,e&&s.data.rooms&&(T.value=s.data.rooms.find(l=>l.roomId===e||l.id===e)))}catch(s){console.error("숙소 정보 로드 실패:",s)}try{const s=await ie();s.ok&&s.data&&(w.value=s.data)}catch(s){console.error("사용자 정보 조회 실패:",s)}try{const s=await ce("ISSUED");q.value=s||[]}catch(s){console.error("쿠폰 조회 실패:",s)}H.value=!1});const O=(a,e)=>{if(!a||!e)return 1;const i=new Date(a),s=new Date(e).getTime()-i.getTime(),l=Math.ceil(s/(1e3*60*60*24));return l>0?l:1},N=a=>{if(!a)return"";const e=new Date(a);if(Number.isNaN(e.getTime()))return"";const i=e.getFullYear(),n=e.getMonth()+1,s=e.getDate();return`${i}년 ${n}월 ${s}일`},o=I(()=>{const a=parseInt(v.guestCount),e=parseInt(c.query.guestCount),i=Number.isNaN(a)?Number.isNaN(e)?1:e:a,n=`게스트 ${i}명`;let s=v.checkin||c.query.checkin||c.query.checkIn||null,l=v.checkout||c.query.checkout||c.query.checkOut||null,x="날짜를 선택하세요";if(s&&l){const R=N(s),$=N(l);R&&$&&(x=`${R} ~ ${$}`)}const L=O(s,l),u=S.value,h=T.value;let C="https://picsum.photos/id/11/800/400";u?.images&&u.images.length>0&&(C=u.images[0].imageUrl||C);let M="";u&&(M=[u.city,u.district,u.township,u.addressDetail].filter(Boolean).join(" "));const V=h?.price||h?.weekendPrice||parseInt(c.query.roomPrice)||15e4;return{accommodationsId:parseInt(v.accommodationsId)||parseInt(c.params.id)||2,roomId:parseInt(v.roomId)||parseInt(c.query.roomId)||2,accommodationName:u?.accommodationsName||c.query.accommodationName||"숙소명 없음",address:M||"주소 정보 없음",rating:u?.rating||parseFloat(c.query.rating)||0,reviewCount:u?.reviewCount||parseInt(c.query.reviewCount)||0,image:C,roomName:h?.roomName||h?.name||c.query.roomName||"객실명 없음",roomDesc:h?.roomDescription||h?.description||"",roomCapacity:h?.maxGuests||h?.capacity||i,dates:x,checkin:s,checkout:l,stayNights:L,guests:n,guestCount:i,price:V*L,pricePerNight:V,currency:"KRW"}}),q=g([]),P=I(()=>{const a=o.value?.price||0;return q.value.filter(e=>{const i=e?.minPrice??0;return a>=i})}),p=g(null),_=g(!1),D=g(""),f=g(!1),U=(a,e)=>{if(!a)return 0;if(a.discountType==="PERCENT"){const i=Math.floor(e*a.discountValue/100);return a.maxDiscount?Math.min(i,a.maxDiscount):i}return a.discountValue||0},b=I(()=>U(p.value,o.value.price)),A=I(()=>o.value.price-b.value);W(P,a=>{p.value&&!a.some(e=>e?.id===p.value?.id)&&(p.value=null)});const G=()=>k.back(),J=async()=>{_.value=!0,D.value="";try{const a=new Date,e=o.value.checkin?new Date(o.value.checkin):new Date(a.getTime()+1440*60*1e3),i=o.value.checkout?new Date(o.value.checkout):new Date(a.getTime()+2880*60*1e3);console.log("예약 생성 데이터:",{checkin:o.value.checkin,checkout:o.value.checkout,guestCount:o.value.guestCount,stayNights:o.value.stayNights,guests:o.value.guests});const n={accommodationsId:o.value.accommodationsId,roomId:o.value.roomId,checkin:e.toISOString(),checkout:i.toISOString(),guestCount:o.value.guestCount,totalAmount:o.value.price,userCouponId:p.value?.id||null,couponDiscountAmount:b.value||0,reserverName:w.value?.email||"예약자",reserverPhone:w.value?.phone||""};console.log("Final Reservation Data Payload:",JSON.stringify(n,null,2));const s=await ne(n);k.push({name:"payment",params:{reservationId:s.reservationId}})}catch(a){console.error("예약 생성 실패:",a),a.message.includes("409")||a.message.includes("Conflict")?(D.value="선택하신 날짜에 이미 예약이 존재합니다.<br>다른 날짜를 선택해주세요.",f.value=!0):(D.value="예약 처리 중 오류가 발생했습니다.<br>다시 시도해주세요.",f.value=!0)}finally{_.value=!1}};return(a,e)=>{const i=se("router-link");return m(),d(B,null,[t("div",le,[t("header",{class:"header"},[t("button",{class:"icon-btn",onClick:G},"←")]),t("div",ue,[e[12]||(e[12]=t("h1",{class:"page-title"},"검토 후 계속 진행",-1)),t("div",de,[t("div",{class:"card-image",style:Y({backgroundImage:`url(${o.value.image})`})},[o.value.image?y("",!0):(m(),d("span",me,"[숙소 이미지]"))],4),t("div",ve,[t("div",pe,[t("h2",null,r(o.value.accommodationName),1),t("p",ge,r(o.value.address),1),o.value.rating?(m(),d("p",he,"★ "+r(o.value.rating)+" (후기 "+r(o.value.reviewCount)+"개)",1)):y("",!0)]),t("div",fe,[e[3]||(e[3]=t("div",{class:"info-label"},[t("span",null,"선택 객실")],-1)),t("p",ye,r(o.value.roomName),1),o.value.roomDesc?(m(),d("p",ke,r(o.value.roomDesc),1)):y("",!0),t("p",_e,"최대 "+r(o.value.roomCapacity)+"명",1)]),t("div",De,[e[4]||(e[4]=t("div",{class:"info-label"},[t("span",null,"날짜")],-1)),t("p",Ie,r(o.value.dates)+" ("+r(o.value.stayNights)+"박)",1)]),t("div",we,[e[5]||(e[5]=t("div",{class:"info-label"},[t("span",null,"게스트")],-1)),t("p",Ne,r(o.value.guests),1)]),t("div",be,[e[7]||(e[7]=t("div",{class:"info-label"},[t("span",null,"쿠폰")],-1)),X(t("select",{"onUpdate:modelValue":e[0]||(e[0]=n=>p.value=n),class:"coupon-select"},[e[6]||(e[6]=t("option",{value:null},"쿠폰 선택 안함",-1)),(m(!0),d(B,null,ee(P.value,n=>(m(),d("option",{key:n.id,value:n},r(n.name)+" ("+r(n.discountType==="PERCENT"?n.discountValue+"%":n.discountValue.toLocaleString()+"원")+" 할인) ",9,Ce))),128))],512),[[Z,p.value]])]),e[10]||(e[10]=t("hr",{class:"divider"},null,-1)),t("div",Se,[t("div",Te,[t("span",null,"₩"+r(o.value.pricePerNight.toLocaleString())+" x "+r(o.value.stayNights)+"박",1),t("span",null,"₩"+r(o.value.price.toLocaleString()),1)]),p.value?(m(),d("div",qe,[t("span",null,"쿠폰 할인 ("+r(p.value.name)+")",1),t("span",Pe,"-₩"+r(b.value.toLocaleString()),1)])):y("",!0),t("div",xe,[e[8]||(e[8]=t("span",null,"총 합계",-1)),t("div",Le,[E(" ₩"+r(A.value.toLocaleString())+" ",1),t("span",Me,r(o.value.currency),1)])])]),e[11]||(e[11]=t("hr",{class:"divider"},null,-1)),t("div",Ve,[o.value.checkin?(m(),d("p",Re," 체크인 날짜인 "+r(N(o.value.checkin))+" 전에 취소하면 부분 환불을 받으실 수 있습니다. ",1)):(m(),d("p",$e,"취소 시 환불 정책이 적용됩니다.")),te(i,{to:"/policy?tab=refund",class:"policy-link"},{default:oe(()=>[...e[9]||(e[9]=[E("환불 정책 전문",-1)])]),_:1})])])])]),t("div",Be,[t("button",{class:"pay-btn",disabled:_.value,onClick:J},r(_.value?"처리 중...":"결제하기"),9,Ee)])]),f.value?(m(),d("div",{key:0,class:"modal-overlay",onClick:e[2]||(e[2]=ae(n=>f.value=!1,["self"]))},[t("div",Fe,[e[13]||(e[13]=t("div",{class:"modal-icon error"},"⚠️",-1)),e[14]||(e[14]=t("h3",null,"예약 실패",-1)),t("p",{class:"modal-desc",innerHTML:D.value},null,8,He),t("button",{class:"close-modal-btn",onClick:e[1]||(e[1]=n=>f.value=!1)},"확인")])])):y("",!0)],64)}}},ze=j(Oe,[["__scopeId","data-v-f352fd35"]]);export{ze as default};
