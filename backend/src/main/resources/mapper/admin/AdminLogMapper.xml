<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssg9th2team.geharbang.domain.admin.repository.mybatis.AdminLogMapper">
    <insert id="insertAdminLog">
        INSERT INTO admin_log (
            admin_id,
            target_type,
            target_id,
            action_type,
            reason,
            metadata_json,
            created_at
        ) VALUES (
            #{adminId},
            #{targetType},
            #{targetId},
            #{actionType},
            #{reason},
            #{metadataJson},
            NOW()
        )
    </insert>

    <select id="selectAdminLogs" resultType="com.ssg9th2team.geharbang.domain.admin.dto.AdminLogRow">
        SELECT
            log_id AS logId,
            admin_id AS adminId,
            target_type AS targetType,
            target_id AS targetId,
            action_type AS actionType,
            reason AS reason,
            metadata_json AS metadataJson,
            created_at AS createdAt
        FROM admin_log
        WHERE 1=1
        <if test="start != null">
            AND created_at &gt;= #{start}
        </if>
        <if test="end != null">
            AND created_at &lt; #{end}
        </if>
        <if test="actionType != null and actionType != ''">
            AND action_type = #{actionType}
        </if>
        <if test="keywordTargetId != null">
            AND target_id = #{keywordTargetId}
        </if>
        <if test="keywordTargetId == null and keyword != null and keyword != ''">
            AND (
                reason LIKE CONCAT('%', #{keyword}, '%')
                OR target_type LIKE CONCAT('%', #{keyword}, '%')
                OR metadata_json LIKE CONCAT('%', #{keyword}, '%')
            )
        </if>
        ORDER BY created_at DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="countAdminLogs" resultType="long">
        SELECT COUNT(*)
        FROM admin_log
        WHERE 1=1
        <if test="start != null">
            AND created_at &gt;= #{start}
        </if>
        <if test="end != null">
            AND created_at &lt; #{end}
        </if>
        <if test="actionType != null and actionType != ''">
            AND action_type = #{actionType}
        </if>
        <if test="keywordTargetId != null">
            AND target_id = #{keywordTargetId}
        </if>
        <if test="keywordTargetId == null and keyword != null and keyword != ''">
            AND (
                reason LIKE CONCAT('%', #{keyword}, '%')
                OR target_type LIKE CONCAT('%', #{keyword}, '%')
                OR metadata_json LIKE CONCAT('%', #{keyword}, '%')
            )
        </if>
    </select>
</mapper>
