# This workflow will do a clean installation of node dependencies, cache/restore them, build the source code and run tests across different versions of node
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-nodejs

 name: Guesthouse Backend CI

  on:
    pull_request:
      branches: [ "develop" ]
    push:
      branches: [ "develop" ]

  jobs:
    backend:
      name: Backend CI (Spring + MySQL Test)
      runs-on: ubuntu-latest

      services:
        mysql:
          image: mysql:8.0
          env:
            MYSQL_ROOT_PASSWORD: root
            MYSQL_DATABASE: guesthouse
          ports:
            - 3306:3306
          options: >-
            --health-cmd="mysqladmin ping -h localhost -uroot -proot"
            --health-interval=10s
            --health-timeout=5s
            --health-retries=5

      steps:
        - uses: actions/checkout@v4

        - name: Set up JDK 17
          uses: actions/setup-java@v4
          with:
            distribution: 'temurin'
            java-version: 17

        - name: Grant gradlew permission
          working-directory: backend
          run: chmod +x gradlew

        - name: Run Spring Tests
          working-directory: backend
          env:
            SPRING_DATASOURCE_URL: jdbc:mysql://localhost:3306/guesthouse?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Seoul
            SPRING_DATASOURCE_USERNAME: root
            SPRING_DATASOURCE_PASSWORD: root
          run: ./gradlew test -Dspring.profiles.active=test
