name: Gemini Code Review

on:
  pull_request:
    types: [opened, synchronize]
    branches: [develop]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          git fetch origin ${{ github.base_ref }}
          # diff ë‚´ìš©ì„ ê°€ì ¸ì˜¤ê³  headë¡œ í¬ê¸°ë¥¼ ì œí•œí•©ë‹ˆë‹¤.
          DIFF=$(git diff origin/${{ github.base_ref }}...HEAD -- '*.java' '*.yml' '*.properties' | head -c 30000)
          # GITHUB_OUTPUTì— ë©€í‹°ë¼ì¸ ë°ì´í„°ë¥¼ ì•ˆì „í•˜ê²Œ ì“°ê¸° ìœ„í•œ ì²˜ë¦¬
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Review with Gemini
        id: review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          DIFF_CONTENT: ${{ steps.diff.outputs.diff }}
        run: |
          if [ -z "$GEMINI_API_KEY" ]; then
            echo "review=API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤." >> $GITHUB_OUTPUT
            exit 0
          fi

          if [ -z "$DIFF_CONTENT" ]; then
            echo "review=ë³€ê²½ëœ ì½”ë“œê°€ ì—†ê±°ë‚˜ íŒŒì¼ í™•ì¥ìê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤." >> $GITHUB_OUTPUT
            exit 0
          fi

          # 1. JSON í˜ì´ë¡œë“œ ìƒì„± (jqë¥¼ ì‚¬ìš©í•˜ì—¬ íŠ¹ìˆ˜ë¬¸ì ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬)
          # v1beta ëŒ€ì‹  ì•ˆì •ì ì¸ v1 ë²„ì „ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•´ í˜•ì‹ì„ ë§ì¶¥ë‹ˆë‹¤.
          PAYLOAD=$(jq -n --arg diff "$DIFF_CONTENT" '{
            "contents": [{
              "parts": [{
                "text": ("ë‹¹ì‹ ì€ ì‹œë‹ˆì–´ ë°±ì—”ë“œ ê°œë°œìì…ë‹ˆë‹¤. ì•„ë˜ ì½”ë“œ ë³€ê²½ì‚¬í•­ì„ ë¦¬ë·°í•´ì£¼ì„¸ìš”.\n\në¦¬ë·° ê¸°ì¤€:\n1. ë²„ê·¸ ê°€ëŠ¥ì„±\n2. ë³´ì•ˆ ì·¨ì•½ì \n3. ì„±ëŠ¥ ì´ìŠˆ\n4. ì½”ë“œ ìŠ¤íƒ€ì¼/ê°€ë…ì„±\n5. ê°œì„  ì œì•ˆ\n\ní•œêµ­ì–´ë¡œ ê°„ê²°í•˜ê²Œ ë‹µë³€í•´ì£¼ì„¸ìš”. ë¬¸ì œê°€ ì—†ìœ¼ë©´ \"LGTM (Looks Good To Me)\"ì´ë¼ê³  ë‹µë³€í•´ì£¼ì„¸ìš”.\n\n```diff\n" + $diff + "\n```")
              }]
            }],
            "generationConfig": {
              "temperature": 0.2,
              "maxOutputTokens": 2048
            }
          }')

          # 2. API í˜¸ì¶œ (v1 API ì£¼ì†Œ ë° ì •ì‹ ëª¨ë¸ëª… ì‚¬ìš©)
          RESPONSE=$(curl -s -X POST \
            "https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          # 3. ì—ëŸ¬ ì²˜ë¦¬ ë¡œì§
          ERROR_MSG=$(echo "$RESPONSE" | jq -r '.error.message // empty')
          if [ -n "$ERROR_MSG" ]; then
            echo "review=API ì˜¤ë¥˜ ë°œìƒ: $ERROR_MSG" >> $GITHUB_OUTPUT
            exit 0
          fi

          # 4. ë¦¬ë·° ê²°ê³¼ ì¶”ì¶œ (ì‘ë‹µ êµ¬ì¡°ì— ë§ì¶° íŒŒì‹±)
          REVIEW=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // "ë¦¬ë·° ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."')
          
          # 5. ê²°ê³¼ ì €ì¥
          echo "review<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post review comment
        if: steps.review.outputs.review != ''
        uses: actions/github-script@v7
        with:
          script: |
            const review = `## ğŸ¤– Gemini ì½”ë“œ ë¦¬ë·°

            ${{ steps.review.outputs.review }}

            ---
            *ì´ ë¦¬ë·°ëŠ” AIê°€ ìë™ìœ¼ë¡œ ìƒì„±í–ˆìŠµë‹ˆë‹¤. ì°¸ê³ ìš©ìœ¼ë¡œë§Œ í™œìš©í•´ì£¼ì„¸ìš”.*`;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: review
            });