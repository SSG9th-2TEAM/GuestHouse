name: Gemini Code Review

on:
  pull_request:
    types: [opened, synchronize]
    branches: [develop]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          git fetch origin ${{ github.base_ref }}
          DIFF=$(git diff origin/${{ github.base_ref }}...HEAD -- '*.java' '*.yml' '*.properties' | head -c 30000)
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Review with Gemini
        id: review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          DIFF_CONTENT: ${{ steps.diff.outputs.diff }}
        run: |
          # API í‚¤ í™•ì¸
          if [ -z "$GEMINI_API_KEY" ]; then
            echo "GEMINI_API_KEY is not set"
            echo "review=API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Repository Settings > Secretsì—ì„œ GEMINI_API_KEYë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”." >> $GITHUB_OUTPUT
            exit 0
          fi

          # diff ë‚´ìš© í™•ì¸
          if [ -z "$DIFF_CONTENT" ]; then
            echo "review=ë³€ê²½ëœ ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤." >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Diff length: ${#DIFF_CONTENT}"

          # JSON í˜ì´ë¡œë“œ ìƒì„±
          PAYLOAD=$(jq -n --arg diff "$DIFF_CONTENT" '{
            "contents": [{
              "parts": [{
                "text": ("ë‹¹ì‹ ì€ ì‹œë‹ˆì–´ ë°±ì—”ë“œ ê°œë°œìì…ë‹ˆë‹¤. ì•„ë˜ ì½”ë“œ ë³€ê²½ì‚¬í•­ì„ ë¦¬ë·°í•´ì£¼ì„¸ìš”.\n\në¦¬ë·° ê¸°ì¤€:\n1. ë²„ê·¸ ê°€ëŠ¥ì„±\n2. ë³´ì•ˆ ì·¨ì•½ì \n3. ì„±ëŠ¥ ì´ìŠˆ\n4. ì½”ë“œ ìŠ¤íƒ€ì¼/ê°€ë…ì„±\n5. ê°œì„  ì œì•ˆ\n\ní•œêµ­ì–´ë¡œ ê°„ê²°í•˜ê²Œ ë‹µë³€í•´ì£¼ì„¸ìš”. ë¬¸ì œê°€ ì—†ìœ¼ë©´ \"LGTM (Looks Good To Me)\"ì´ë¼ê³  ë‹µë³€í•´ì£¼ì„¸ìš”.\n\n```diff\n" + $diff + "\n```")
              }]
            }],
            "generationConfig": {
              "temperature": 0.3,
              "maxOutputTokens": 2048
            }
          }')

          RESPONSE=$(curl -s "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          # ì‘ë‹µ ë””ë²„ê¹…
          echo "API Response: $RESPONSE"

          # ì—ëŸ¬ í™•ì¸
          ERROR=$(echo "$RESPONSE" | jq -r '.error.message // empty')
          if [ -n "$ERROR" ]; then
            echo "review=API ì˜¤ë¥˜: $ERROR" >> $GITHUB_OUTPUT
            exit 0
          fi

          REVIEW=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // "ë¦¬ë·° ìƒì„± ì‹¤íŒ¨"')
          echo "review<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post review comment
        uses: actions/github-script@v7
        with:
          script: |
            const review = `## ğŸ¤– Gemini ì½”ë“œ ë¦¬ë·°

            ${{ steps.review.outputs.review }}

            ---
            *ì´ ë¦¬ë·°ëŠ” AIê°€ ìë™ìœ¼ë¡œ ìƒì„±í–ˆìŠµë‹ˆë‹¤. ì°¸ê³ ìš©ìœ¼ë¡œë§Œ í™œìš©í•´ì£¼ì„¸ìš”.*`;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: review
            });
